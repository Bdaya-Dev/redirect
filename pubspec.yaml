name: redirect_workspace
publish_to: none

environment:
  sdk: ^3.10.0
  flutter: ">=3.38.0"

workspace:
  - packages/redirect
  - packages/redirect/example
  - packages/redirect_android
  - packages/redirect_io
  - packages/redirect_core
  - packages/redirect_darwin
  - packages/redirect_desktop
  - packages/redirect_platform_interface  
  - packages/redirect_web
  - packages/redirect_web_core

dev_dependencies:
  melos: ^7.1.1

melos:
  repository: https://github.com/Bdaya-Dev/redirect

  command:
    bootstrap:
      runPubGetInParallel: false
    clean:
      hooks:
        post: |
          melos exec --flutter -- "flutter clean" &&
          rm -rf coverage &&
          rm -rf pubspec.lock &&
          melos exec --dir-exists coverage -- "rm -rf coverage"

  scripts:
    analyze:
      description: Analyze all packages
      exec: dart analyze

    format:
      description: Format check all packages
      exec: dart format --set-exit-if-changed .

    format:fix:
      description: Format all packages
      exec: dart format .

    test:
      name: All tests
      run: |
        melos run test:dart
        melos run test:dart:chrome
        melos run test:dart:wasm
        melos run test:flutter

    test:dart:
      name: Dart tests
      exec: dart test --coverage=coverage
      packageFilters:
        flutter: false
        dirExists: test

    test:dart:chrome:
      name: Dart browser tests (requires Chrome)
      exec: dart test -p chrome --coverage=coverage
      packageFilters:
        scope:
          - "redirect_web_core"

    test:dart:wasm:
      name: Dart browser tests via dart2wasm (requires Chrome)
      exec: dart test -p chrome -c dart2wasm
      packageFilters:
        scope:
          - "redirect_web_core"

    test:jaspr:
      name: Jaspr integration tests (component + SSR)
      exec: dart test test/integration/redirect_jaspr_integration_test.dart
      packageFilters:
        scope:
          - "redirect_web_core"

    test:web-integration:
      name: Web integration tests (BroadcastChannel, iframes, popups)
      exec: dart test -p chrome test/integration/redirect_web_integration_test.dart
      packageFilters:
        scope:
          - "redirect_web_core"

    test:native:android:
      name: Android native unit tests (Kotlin + Robolectric)
      description: >-
        Runs native Kotlin unit tests via Gradle.
        Requires Android SDK and JDK 17+.
      exec: cd android && ../../../packages/redirect/example/android/gradlew testDebugUnitTest
      packageFilters:
        scope:
          - "redirect_android"

    test:integration:
      name: All integration tests (platform)
      description: >-
        Runs the full e2e integration test suite.
        Must specify a device with -d <device>.
      exec: flutter test integration_test/redirect_e2e_test.dart
      packageFilters:
        scope:
          - "redirect_example"

    test:integration:android:
      name: Android integration tests
      description: Runs Android-specific integration tests on device/emulator.
      exec: flutter test integration_test/redirect_android_test.dart
      packageFilters:
        scope:
          - "redirect_example"

    test:integration:darwin:
      name: Darwin (iOS/macOS) integration tests
      description: Runs Darwin-specific integration tests on device/simulator.
      exec: flutter test integration_test/redirect_darwin_test.dart
      packageFilters:
        scope:
          - "redirect_example"

    test:integration:desktop:
      name: Desktop (Linux/Windows) integration tests
      description: Runs desktop-specific integration tests.
      exec: flutter test integration_test/redirect_desktop_test.dart
      packageFilters:
        scope:
          - "redirect_example"

    test:integration:platform:
      name: Platform UI integration tests (all platforms)
      description: Runs the original platform UI + cancel tests.
      exec: flutter test integration_test/redirect_platform_test.dart
      packageFilters:
        scope:
          - "redirect_example"

    test:integration:web:
      name: Web integration tests (requires chromedriver)
      description: >-
        Runs web-specific integration tests via flutter drive.
        Requires chromedriver on port 4444.
      exec: >-
        flutter drive
        --driver=test_driver/integration_test.dart
        --target=integration_test/redirect_web_integration_test.dart
        -d web-server
      packageFilters:
        scope:
          - "redirect_example"

    test:flutter:
      name: Flutter tests
      exec: flutter test --coverage --branch-coverage
      packageFilters:
        flutter: true
        dirExists: test
        ignore:
          - "*example*"
          - "redirect_web"

    pana:
      run: melos exec -c 1 "pana"
      description: Run pana on all the projects
      packageFilters:
        noPrivate: true

    coverage:clean:
      name: Clear coverage
      exec: rm -rf coverage

    coverage:combine:
      name: Combine coverage reports
      run: |
        dart pub global activate combine_coverage
        dart pub global activate remove_from_coverage
        dart pub global run combine_coverage --repo-path=$pwd
        dart pub global run remove_from_coverage:remove_from_coverage -f coverage/lcov.info -r '\.g\.dart$'
