name: redirect_workspace
publish_to: none

environment:
  sdk: ^3.10.0
  flutter: ">=3.38.0"

workspace:
  - packages/redirect
  - packages/redirect/example
  - packages/redirect_android
  - packages/redirect_cli
  - packages/redirect_core
  - packages/redirect_darwin
  - packages/redirect_desktop
  - packages/redirect_platform_interface  
  - packages/redirect_web
  - packages/redirect_web_core

dev_dependencies:
  melos: ^7.1.1

melos:
  repository: https://github.com/Bdaya-Dev/redirect

  command:
    bootstrap:
      runPubGetInParallel: false
    clean:
      hooks:
        post: |
          melos exec --flutter -- "flutter clean" &&
          rm -rf coverage &&
          rm -rf pubspec.lock &&
          melos exec --dir-exists coverage -- "rm -rf coverage"

  scripts:
    analyze:
      description: Analyze all packages
      exec: dart analyze

    format:
      description: Format check all packages
      exec: dart format --set-exit-if-changed .

    format:fix:
      description: Format all packages
      exec: dart format .

    test:
      name: All tests
      run: |
        melos run test:dart
        melos run test:dart:chrome
        melos run test:dart:wasm
        melos run test:flutter
        melos run test:web

    test:dart:
      name: Dart tests
      exec: dart test --coverage=coverage
      packageFilters:
        flutter: false
        dirExists: test

    test:dart:chrome:
      name: Dart browser tests (requires Chrome)
      exec: dart test -p chrome --coverage=coverage
      packageFilters:
        scope:
          - "redirect_web_core"

    test:dart:wasm:
      name: Dart browser tests via dart2wasm (requires Chrome)
      exec: dart test -p chrome -c dart2wasm
      packageFilters:
        scope:
          - "redirect_web_core"

    test:flutter:
      name: Flutter tests
      exec: flutter test --coverage --branch-coverage
      packageFilters:
        flutter: true
        dirExists: test
        ignore:
          - "*example*"
          - "redirect_web"

    test:web:
      name: Flutter web tests (requires Chrome)
      exec: flutter test --platform chrome --coverage --branch-coverage
      packageFilters:
        scope:
          - "redirect_web"

    pana:
      run: melos exec -c 1 "pana"
      description: Run pana on all the projects
      packageFilters:
        noPrivate: true

    coverage:clean:
      name: Clear coverage
      exec: rm -rf coverage

    coverage:combine:
      name: Combine coverage reports
      run: |
        dart pub global activate combine_coverage
        dart pub global activate remove_from_coverage
        dart pub global run combine_coverage --repo-path=$pwd
        dart pub global run remove_from_coverage:remove_from_coverage -f coverage/lcov.info -r '\.g\.dart$'
