name: redirect

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    paths:
      - ".github/workflows/redirect.yaml"
      - "packages/redirect/**"
      - "packages/redirect/example/**"
      - "packages/redirect_platform_interface/**"
      - "packages/redirect_core/**"
      - "packages/redirect_android/**"
      - "packages/redirect_darwin/**"
      - "packages/redirect_desktop/**"
      - "packages/redirect_web/**"
      - "packages/redirect_web_core/**"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/redirect.yaml"
      - "packages/redirect/**"
      - "packages/redirect/example/**"
      - "packages/redirect_platform_interface/**"
      - "packages/redirect_core/**"
      - "packages/redirect_android/**"
      - "packages/redirect_darwin/**"
      - "packages/redirect_desktop/**"
      - "packages/redirect_web/**"
      - "packages/redirect_web_core/**"

jobs:
  spell-check:
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/spell_check.yml@v1
    with:
      includes: |
        **/*.md
        !brick/**/*.md
        .*/**/*.md
      modified_files_only: false

  build:
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/flutter_package.yml@v1
    with:
      flutter_version: 3.35.0
      working_directory: packages/redirect

  pana:
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/pana.yml@v1
    with:
      working_directory: packages/redirect

  # ───────────────────────────────────────────────────────────
  # Android — integration tests on emulator
  # ───────────────────────────────────────────────────────────

  android:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD Cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-34-x86_64

      - name: Create AVD snapshot
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: echo "Generated AVD snapshot for caching."

      - name: Integration tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: flutter test integration_test/redirect_platform_test.dart --timeout 120s
          working-directory: packages/redirect/example

  # ───────────────────────────────────────────────────────────
  # iOS — integration tests on simulator
  # ───────────────────────────────────────────────────────────

  ios:
    runs-on: macos-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Start Simulator
        run: |
          UDID=$(xcrun simctl list devices available -j \
            | python3 -c "import sys,json; devs=json.load(sys.stdin)['devices']; print(next(d['udid'] for r in devs.values() for d in r if 'iPhone' in d['name'] and d['isAvailable']))")
          echo "Booting simulator: $UDID"
          xcrun simctl boot "$UDID"

      - name: Integration tests
        run: |
          flutter test integration_test/redirect_platform_test.dart \
            -d iPhone --timeout 120s

  # ───────────────────────────────────────────────────────────
  # macOS — integration tests
  # ───────────────────────────────────────────────────────────

  macos:
    runs-on: macos-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Integration tests
        run: |
          flutter test integration_test/redirect_platform_test.dart \
            -d macos --timeout 120s

  # ───────────────────────────────────────────────────────────
  # Linux — integration tests
  # ───────────────────────────────────────────────────────────

  linux:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev libx11-dev pkg-config cmake ninja-build \
            libblkid-dev liblzma-dev xvfb

      - name: Install dependencies
        run: flutter pub get

      - name: Integration tests
        run: |
          xvfb-run flutter test integration_test/redirect_platform_test.dart \
            -d linux --timeout 120s

  # ───────────────────────────────────────────────────────────
  # Windows — integration tests
  # ───────────────────────────────────────────────────────────

  windows:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Integration tests
        run: flutter test integration_test/redirect_platform_test.dart -d windows --timeout 120s

  # ───────────────────────────────────────────────────────────
  # Web — widget tests on Chrome (real web APIs)
  # ───────────────────────────────────────────────────────────

  flutter-web-chrome:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Web widget tests (Chrome)
        run: |
          xvfb-run flutter test test/redirect_web_integration_test.dart \
            -d chrome --timeout 120s

  # ───────────────────────────────────────────────────────────
  # Flutter Web (JS) — integration tests via flutter drive
  # ───────────────────────────────────────────────────────────

  flutter-web-js:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Start ChromeDriver
        run: chromedriver --port=4444 &

      - name: Integration tests (JS)
        run: |
          xvfb-run flutter drive \
            --driver=test_driver/integration_test.dart \
            --target=integration_test/redirect_web_integration_test.dart \
            -d web-server

  # ───────────────────────────────────────────────────────────
  # Flutter Web (WASM / dart2wasm) — integration tests
  # ───────────────────────────────────────────────────────────

  flutter-web-wasm:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: packages/redirect/example

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.0
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Start ChromeDriver
        run: chromedriver --port=4444 &

      - name: Integration tests (WASM)
        run: |
          xvfb-run flutter drive \
            --driver=test_driver/integration_test.dart \
            --target=integration_test/redirect_web_integration_test.dart \
            -d web-server \
            --wasm
